<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Call Calendar</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f3f2f1;
            color: #323130;
            min-height: 100vh;
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            text-align: center;
            padding: 24px 0 20px;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #0078d4;
            letter-spacing: -0.01em;
        }
        .header p {
            color: #605e5c;
            font-size: 0.875rem;
            margin-top: 4px;
        }

        /* â”€â”€ Controls bar â”€â”€ */
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            background: #fff;
            border: 1px solid #edebe9;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: 0 1.6px 3.6px rgba(0,0,0,.07);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #323130;
            white-space: nowrap;
        }
        .filter-select {
            padding: 6px 10px;
            border: 1px solid #8a8886;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-family: inherit;
            color: #323130;
            background: #fff;
            cursor: pointer;
            min-width: 130px;
        }
        .filter-select:focus {
            outline: 2px solid #0078d4;
            outline-offset: -1px;
            border-color: transparent;
        }

        .ctrl-divider { width: 1px; height: 28px; background: #edebe9; flex-shrink: 0; }

        /* OUTLOOK SYNC â€” commented out
        .sync-count {
            font-size: 0.75rem;
            color: #605e5c;
            white-space: nowrap;
        }

        .sync-btn {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 8px 16px;
            background: #0078d4;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background .15s;
        }
        .sync-btn:hover { background: #106ebe; }
        .sync-btn:active { background: #005a9e; }
        .sync-btn svg { flex-shrink: 0; }
        END OUTLOOK SYNC */

        /* â”€â”€ Notes panel â”€â”€ */
        .notes-panel {
            background: #deecf9;
            border: 1px solid #c7e0f4;
            border-left: 4px solid #0078d4;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: none;
        }
        .notes-panel.open { display: block; }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .notes-label {
            font-size: 0.6875rem;
            font-weight: 700;
            color: #0078d4;
            text-transform: uppercase;
            letter-spacing: .07em;
        }
        .notes-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #605e5c;
            font-size: 1rem;
            line-height: 1;
            padding: 0 2px;
        }
        .notes-close:hover { color: #323130; }

        .notes-meta {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #323130;
            margin-bottom: 3px;
        }
        .notes-people {
            font-size: 0.75rem;
            color: #605e5c;
            margin-bottom: 6px;
        }
        .notes-body {
            font-size: 0.875rem;
            color: #323130;
            line-height: 1.5;
        }

        /* â”€â”€ Month navigation â”€â”€ */
        .cal-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border: 1px solid #edebe9;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 10px 16px;
        }
        .nav-btn {
            background: none;
            border: 1px solid #edebe9;
            border-radius: 4px;
            padding: 5px 12px;
            cursor: pointer;
            color: #323130;
            font-size: 1.1rem;
            line-height: 1;
            transition: background .1s;
        }
        .nav-btn:hover { background: #f3f2f1; }
        .month-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #323130;
            min-width: 210px;
            text-align: center;
        }

        /* â”€â”€ Calendar grid â”€â”€ */
        .calendar {
            background: #fff;
            border: 1px solid #edebe9;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            box-shadow: 0 1.6px 3.6px rgba(0,0,0,.07);
        }

        .dow-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #0078d4;
        }
        .dow-row div {
            padding: 9px 6px;
            text-align: center;
            font-size: 0.6875rem;
            font-weight: 700;
            color: rgba(255,255,255,.92);
            text-transform: uppercase;
            letter-spacing: .08em;
        }
        .dow-row div.weekend-hdr { background: rgba(0,0,0,.12); }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        /* Day cell base */
        .cell {
            border-right: 1px solid #edebe9;
            border-bottom: 1px solid #edebe9;
            padding: 6px 8px 8px;
            min-height: 88px;
            position: relative;
            background: #fff;
        }
        .cell:nth-child(7n) { border-right: none; }
        .cell.empty { background: #faf9f8; }
        .cell.wknd  { background: #f9f8fc; }
        .cell.empty.wknd { background: #f4f2f8; }

        /* Highlighted cells when filter active */
        .cell.hi-oncall { background: #dff6dd !important; }
        .cell.hi-backup { background: #fff4ce !important; }
        .cell.hi-both   { background: #deecf9 !important; }

        /* Dimmed when not matching filter */
        .cell.dim .cell-oncall,
        .cell.dim .cell-backup,
        .cell.dim .notes-dot { opacity: .2; }

        /* Today ring */
        .day-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #605e5c;
            border-radius: 50%;
            margin-bottom: 4px;
        }
        .cell.today .day-num {
            background: #0078d4;
            color: #fff;
            font-weight: 700;
        }
        .cell.wknd .day-num { color: #8764b8; }
        .cell.today.wknd .day-num { background: #8764b8; color: #fff; }

        .cell-oncall {
            font-size: 0.75rem;
            font-weight: 600;
            color: #323130;
            line-height: 1.35;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cell-backup {
            font-size: 0.6875rem;
            color: #605e5c;
            line-height: 1.3;
        }

        /* Notes dot/icon */
        .notes-dot {
            position: absolute;
            top: 5px;
            right: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            user-select: none;
            transition: transform .15s, opacity .15s;
            opacity: .75;
        }
        .notes-dot:hover { opacity: 1; transform: scale(1.2); }

        /* â”€â”€ Legend â”€â”€ */
        .legend {
            display: none;
            flex-wrap: wrap;
            gap: 14px;
            align-items: center;
            padding: 10px 16px;
            margin-top: 10px;
            background: #fff;
            border: 1px solid #edebe9;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #605e5c;
        }
        .legend.show { display: flex; }
        .legend strong { color: #323130; font-size: 0.75rem; }
        .leg-item { display: flex; align-items: center; gap: 5px; }
        .leg-swatch {
            width: 13px;
            height: 13px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,.08);
            flex-shrink: 0;
        }

        /* â”€â”€ Empty month message â”€â”€ */
        .no-data-msg {
            grid-column: 1 / -1;
            padding: 40px;
            text-align: center;
            color: #a19f9d;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<div class="app">

    <!-- Header -->
    <div class="header">
        <h1>On-Call Calendar</h1>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="filter-group">
            <span class="filter-label">On-Call:</span>
            <select class="filter-select" id="filter-oncall">
                <option value="">&#8212; All &#8212;</option>
            </select>
        </div>
        <div class="ctrl-divider"></div>
        <div class="filter-group">
            <span class="filter-label">Backup:</span>
            <select class="filter-select" id="filter-backup">
                <option value="">&#8212; All &#8212;</option>
            </select>
        </div>
        <!-- OUTLOOK SYNC â€” commented out
        <span class="sync-count" id="sync-count"></span>
        <button class="sync-btn" onclick="syncToOutlook()">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1.5" y="2" width="12" height="11.5" rx="1.5" stroke="currentColor" stroke-width="1.3"/>
                <path d="M1.5 6h12" stroke="currentColor" stroke-width="1.3"/>
                <path d="M5 1v2M10 1v2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
            </svg>
            Sync to Outlook
        </button>
        END OUTLOOK SYNC -->
    </div>

    <!-- Notes panel -->
    <div class="notes-panel" id="notes-panel">
        <div class="notes-header">
            <span class="notes-label">&#128203; Notes</span>
            <button class="notes-close" onclick="closeNotes()" title="Close">&#10005;</button>
        </div>
        <div class="notes-meta" id="notes-meta"></div>
        <div class="notes-people" id="notes-people"></div>
        <div class="notes-body" id="notes-body"></div>
    </div>

    <!-- Month navigation -->
    <div class="cal-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">&#8249;</button>
        <div class="month-title" id="month-title">Loading&hellip;</div>
        <button class="nav-btn" onclick="changeMonth(1)">&#8250;</button>
    </div>

    <!-- Calendar -->
    <div class="calendar">
        <div class="dow-row">
            <div class="weekend-hdr">Sun</div>
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div>
            <div class="weekend-hdr">Sat</div>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
    </div>

    <!-- Legend (visible only when filter active) -->
    <div class="legend" id="legend">
        <strong>Legend:</strong>
        <div class="leg-item"><div class="leg-swatch" style="background:#dff6dd"></div>On-Call</div>
        <div class="leg-item"><div class="leg-swatch" style="background:#fff4ce"></div>Backup</div>
        <div class="leg-item"><div class="leg-swatch" style="background:#deecf9"></div>Both roles</div>
        <div class="leg-item">&#128203; Has notes</div>
    </div>

</div><!-- .app -->

<script>
    'use strict';

    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let schedule = {};   // "YYYY-MM-DD" â†’ { onCall, backup, notes }
    let curYear, curMonth;

    // â”€â”€â”€ CSV parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseCSVLine(line) {
        const fields = [];
        let field = '';
        let inQ = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
                inQ = !inQ;
            } else if (ch === ',' && !inQ) {
                fields.push(field.trim());
                field = '';
            } else {
                field += ch;
            }
        }
        fields.push(field.trim());
        return fields;
    }

    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) return;

        // Normalise header names to lowercase, strip BOM
        const raw = lines[0].replace(/^\uFEFF/, '');
        const headers = parseCSVLine(raw).map(h => h.trim().toLowerCase());

        for (let i = 1; i < lines.length; i++) {
            const vals = parseCSVLine(lines[i]);
            const row = {};
            headers.forEach((h, idx) => { row[h] = (vals[idx] !== undefined ? vals[idx] : '').trim(); });

            if (!row.date) continue;

            // Date format: MM-DD-YYYY
            const parts = row.date.split('-');
            if (parts.length !== 3) continue;
            const [mm, dd, yyyy] = parts;
            const key = `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;

            schedule[key] = {
                onCall: row.oncall  || '',
                backup: row.backup  || '',
                notes:  row.notes   || ''
            };
        }
    }

    // â”€â”€â”€ Filter helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function filterOncall() { return document.getElementById('filter-oncall').value; }
    function filterBackup() { return document.getElementById('filter-backup').value; }

    function filteredEntries() {
        const fo = filterOncall(), fb = filterBackup();
        return Object.entries(schedule).filter(([, d]) => {
            if (!fo && !fb) return true;
            return (fo && d.onCall === fo) || (fb && d.backup === fb);
        });
    }

    // â”€â”€â”€ Populate filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setupFilters() {
        const oncallSet = new Set(), backupSet = new Set();
        Object.values(schedule).forEach(d => {
            if (d.onCall) oncallSet.add(d.onCall);
            if (d.backup) backupSet.add(d.backup);
        });

        const sel1 = document.getElementById('filter-oncall');
        const sel2 = document.getElementById('filter-backup');

        [...oncallSet].sort().forEach(n => sel1.add(new Option(n, n)));
        [...backupSet].sort().forEach(n => sel2.add(new Option(n, n)));

        sel1.addEventListener('change', onFilterChange);
        sel2.addEventListener('change', onFilterChange);
    }

    function onFilterChange() {
        render();
        // updateSyncCount(); // OUTLOOK SYNC â€” commented out
        updateLegend();
    }

    /* OUTLOOK SYNC â€” commented out
    function updateSyncCount() {
        const count = filteredEntries().length;
        const fo = filterOncall(), fb = filterBackup();
        document.getElementById('sync-count').textContent =
            (fo || fb) ? `${count} day${count !== 1 ? 's' : ''} selected` : `${count} total days`;
    }
    END OUTLOOK SYNC */

    function updateLegend() {
        const el = document.getElementById('legend');
        el.classList.toggle('show', !!(filterOncall() || filterBackup()));
    }

    // â”€â”€â”€ Month navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function changeMonth(dir) {
        curMonth += dir;
        if (curMonth < 0)  { curMonth = 11; curYear--; }
        if (curMonth > 11) { curMonth = 0;  curYear++; }
        render();
    }

    const MONTH_NAMES = [
        'January','February','March','April','May','June',
        'July','August','September','October','November','December'
    ];

    // â”€â”€â”€ Calendar render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
        const fo = filterOncall(), fb = filterBackup();
        const hasFilter = fo || fb;

        document.getElementById('month-title').textContent = `${MONTH_NAMES[curMonth]} ${curYear}`;

        const grid = document.getElementById('cal-grid');
        grid.innerHTML = '';

        const todayDate = new Date();
        const todayKey = dateKey(todayDate.getFullYear(), todayDate.getMonth() + 1, todayDate.getDate());

        const firstDOW   = new Date(curYear, curMonth, 1).getDay();      // 0=Sun
        const daysInMon  = new Date(curYear, curMonth + 1, 0).getDate();

        let hasAnyData = false;

        // Leading blanks
        for (let i = 0; i < firstDOW; i++) {
            grid.appendChild(emptyCell(i));
        }

        // Day cells
        for (let day = 1; day <= daysInMon; day++) {
            const mm  = curMonth + 1;
            const key = dateKey(curYear, mm, day);
            const data = schedule[key];
            const dow  = new Date(curYear, curMonth, day).getDay();
            const isWknd  = dow === 0 || dow === 6;
            const isToday = key === todayKey;

            const cell = document.createElement('div');
            let cls = 'cell';
            if (isWknd)  cls += ' wknd';
            if (isToday) cls += ' today';

            if (data && hasFilter) {
                const mo = fo && data.onCall === fo;
                const mb = fb && data.backup === fb;
                if      (mo && mb) cls += ' hi-both';
                else if (mo)       cls += ' hi-oncall';
                else if (mb)       cls += ' hi-backup';
                else               cls += ' dim';
            }
            cell.className = cls;

            // Day number
            const dn = document.createElement('div');
            dn.className = 'day-num';
            dn.textContent = day;
            cell.appendChild(dn);

            if (data) {
                hasAnyData = true;

                const oc = document.createElement('div');
                oc.className = 'cell-oncall';
                oc.textContent = data.onCall;
                cell.appendChild(oc);

                const bk = document.createElement('div');
                bk.className = 'cell-backup';
                bk.textContent = `(${data.backup})`;
                cell.appendChild(bk);

                if (data.notes) {
                    const dot = document.createElement('span');
                    dot.className = 'notes-dot';
                    dot.title = 'View notes';
                    dot.textContent = '\u{1F4CB}';   // ðŸ“‹
                    dot.dataset.key = key;
                    cell.appendChild(dot);
                }
            }

            grid.appendChild(cell);
        }

        // Trailing blanks
        const total    = firstDOW + daysInMon;
        const trailing = total % 7 === 0 ? 0 : 7 - (total % 7);
        for (let i = 0; i < trailing; i++) {
            grid.appendChild(emptyCell((total + i) % 7));
        }

        if (!hasAnyData) {
            const msg = document.createElement('div');
            msg.className = 'no-data-msg';
            msg.textContent = 'No schedule data for this month.';
            grid.appendChild(msg);
        }
    }

    function emptyCell(dow) {
        const cell = document.createElement('div');
        cell.className = 'cell empty' + ((dow === 0 || dow === 6) ? ' wknd' : '');
        return cell;
    }

    // â”€â”€â”€ Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('cal-grid').addEventListener('click', function(e) {
        const dot = e.target.closest('.notes-dot');
        if (dot) showNotes(dot.dataset.key);
    });

    function showNotes(key) {
        const data = schedule[key];
        if (!data || !data.notes) return;

        const [y, m, d] = key.split('-').map(Number);
        const date = new Date(y, m - 1, d);
        const formatted = date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        document.getElementById('notes-meta').textContent   = formatted;
        document.getElementById('notes-people').textContent =
            `On-Call: ${data.onCall}  \u2022  Backup: ${data.backup}`;
        document.getElementById('notes-body').textContent   = data.notes;

        const panel = document.getElementById('notes-panel');
        panel.classList.add('open');
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function closeNotes() {
        document.getElementById('notes-panel').classList.remove('open');
    }

    // â”€â”€â”€ Outlook / ICS sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function pad2(n) { return String(n).padStart(2, '0'); }

    function dateKey(y, m, d) {
        return `${y}-${pad2(m)}-${pad2(d)}`;
    }

    /* OUTLOOK SYNC â€” commented out
    function icsDate(key) { return key.replace(/-/g, ''); }

    function icsNextDay(key) {
        const [y, m, d] = key.split('-').map(Number);
        const next = new Date(y, m - 1, d + 1);
        return `${next.getFullYear()}${pad2(next.getMonth() + 1)}${pad2(next.getDate())}`;
    }

    function escICS(str) {
        return str
            .replace(/\\/g, '\\\\')
            .replace(/;/g,  '\\;')
            .replace(/,/g,  '\\,')
            .replace(/\r?\n/g, '\\n');
    }

    function syncToOutlook() {
        const entries = filteredEntries();
        if (entries.length === 0) {
            alert('No matching entries to sync. Please adjust your filters.');
            return;
        }

        const fo = filterOncall(), fb = filterBackup();
        const now = new Date();
        const dtstamp = [
            now.getUTCFullYear(), pad2(now.getUTCMonth() + 1), pad2(now.getUTCDate()),
            'T',
            pad2(now.getUTCHours()), pad2(now.getUTCMinutes()), pad2(now.getUTCSeconds()),
            'Z'
        ].join('');

        const lines = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//OnCall Calendar//EN',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH',
            'X-WR-CALNAME:On-Call Schedule',
            'X-WR-CALDESC:On-call duty schedule'
        ];

        entries.forEach(([key, data]) => {
            const dtstart = icsDate(key);
            const dtend   = icsNextDay(key);

            // Build role tags for summary
            const roles = [];
            if (fo && data.onCall === fo) roles.push('On-Call');
            if (fb && data.backup === fb) roles.push('Backup');
            const roleTag = roles.length ? `[${roles.join('/')}] ` : '';

            const summary = `${roleTag}On-Call: ${data.onCall} (Backup: ${data.backup})`;

            let desc = `On-Call: ${data.onCall}\\nBackup: ${data.backup}`;
            if (data.notes) desc += `\\nNotes: ${escICS(data.notes)}`;

            lines.push('BEGIN:VEVENT');
            lines.push(`DTSTART;VALUE=DATE:${dtstart}`);
            lines.push(`DTEND;VALUE=DATE:${dtend}`);
            lines.push(`DTSTAMP:${dtstamp}`);
            lines.push(`UID:oncall-${key}@oncallcal.local`);
            lines.push(`SUMMARY:${escICS(summary)}`);
            lines.push(`DESCRIPTION:${desc}`);
            lines.push('TRANSP:TRANSPARENT');   // show as free (informational)
            lines.push('END:VEVENT');
        });

        lines.push('END:VCALENDAR');

        const content  = lines.join('\r\n');
        const blob     = new Blob([content], { type: 'text/calendar;charset=utf-8' });
        const url      = URL.createObjectURL(blob);
        const anchor   = document.createElement('a');
        const filename = fo ? `oncall-${fo.toLowerCase()}.ics`
                       : fb ? `oncall-backup-${fb.toLowerCase()}.ics`
                       :       'oncall-schedule.ics';

        anchor.href     = url;
        anchor.download = filename;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        setTimeout(() => URL.revokeObjectURL(url), 1500);
    }
    END OUTLOOK SYNC */

    // â”€â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
        try {
            const res = await fetch('callroll.csv');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            parseCSV(text);
        } catch (e) {
            document.getElementById('cal-grid').innerHTML =
                `<div class="no-data-msg" style="color:#a80000">
                    Failed to load <code>callroll.csv</code>: ${e.message}<br>
                    should be running from a web server.
                 </div>`;
            document.getElementById('month-title').textContent = 'Error';
            return;
        }

        setupFilters();

        // Navigate to today; if today has no data use the first date in the CSV
        const today = new Date();
        curYear  = today.getFullYear();
        curMonth = today.getMonth();

        // updateSyncCount(); // OUTLOOK SYNC â€” commented out
        render();
    }

    init();
</script>
</body>
</html>
